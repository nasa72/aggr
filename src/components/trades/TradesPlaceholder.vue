<template>
  <div class="trades-placeholder hide-scrollbar">
    <p class="trades-placeholder__dimmed">{{ filterRecap }}</p>
    <p v-if="!exchangesReady">...</p>
    <template v-else>
      <pre v-if="showMore" v-text="paneMarketStringified"></pre>
      <div v-else class="pl16 pr16">
        <button class="btn -accent mx4 -small" v-for="(pair, index) of pairs" :key="index" disabled>{{ pair }}</button>
      </div>
      <button class="mt8 btn -text trades-placeholder__dimmed -small" @click="toggleShowMore">
        {{ showMore ? 'Show less' : 'Show more' }}
      </button>
    </template>
  </div>
</template>

<script lang="ts">
import { Threshold } from '@/store/panesSettings/trades'
import { formatAmount, parseMarket } from '@/utils/helpers'
import { Component, Vue } from 'vue-property-decorator'

@Component({
  name: 'TradesPlaceholder',
  props: {
    paneId: {
      type: String,
      required: true
    }
  }
})
export default class extends Vue {
  paneId: string
  showMore = false

  get exchangesReady() {
    return this.$store.state.app.isExchangesReady
  }

  get paneMarkets() {
    return this.$store.state.panes.panes[this.paneId].markets
  }

  get paneMarketStringified() {
    return this.paneMarkets.join('\n')
  }

  get pairs() {
    const indexedProducts = this.$store.state.app.indexedProducts
    const mergeUsdt = this.$store.state.settings.searchTypes.mergeUsdt

    return this.paneMarkets.reduce((pairs, market) => {
      const [exchange] = parseMarket(market)

      let indexedProduct

      if (indexedProducts[exchange]) {
        indexedProduct = indexedProducts[exchange].find(product => product.id === market)
      }

      let localPair = indexedProduct ? indexedProduct.local : market

      if (mergeUsdt) {
        localPair = localPair.replace('USDT', 'USD').replace('USDC', 'USD')
      }

      if (pairs.indexOf(localPair) === -1) {
        pairs.push(localPair)
      }

      return pairs
    }, [])
  }

  get tradesThresholds(): Threshold[] {
    return this.$store.state[this.paneId].thresholds
  }

  get liquidationsThresholds(): Threshold[] {
    return this.$store.state[this.paneId].liquidations
  }

  get tradeType() {
    return this.$store.state[this.paneId].tradeType
  }

  get filterRecap() {
    const minimumTradeAmount = this.tradesThresholds[0].amount
    const minimumLiquidationAmount = this.liquidationsThresholds[0].amount
    const minimumAmount = Math.min(minimumTradeAmount, minimumLiquidationAmount)

    if (this.tradeType === 'both') {
      return `Waiting for trades or liquidations > ${formatAmount(minimumAmount)}`
    } else if (this.tradeType === 'trades') {
      return `Waiting for trades > ${formatAmount(minimumTradeAmount)}`
    } else {
      return `Waiting for liquidations > ${formatAmount(minimumLiquidationAmount)}`
    }
  }

  toggleShowMore() {
    this.showMore = !this.showMore

    const focusedElement = document.activeElement as HTMLElement

    if (focusedElement) {
      focusedElement.blur()
    }
  }
}
</script>

<style lang="scss">
.trades-placeholder {
  padding: 2em;
  margin: auto;

  p {
    margin-top: 0;
  }

  .trades-placeholder__dimmed {
    opacity: 0.5;
  }

  pre {
    font-size: 0.75em;
    pointer-events: all;
    user-select: text;
  }
}
</style>
